name: Build Offline Database

on:
  workflow_dispatch:
    inputs:
      region:
        description: 'Region to build (e.g., europe/spain, asia/japan, virginia)'
        required: true
        type: string
      upload_to_release:
        description: 'Upload to releases (true/false)'
        required: false
        default: 'true'
        type: string

permissions:
  contents: write  # Required to create releases and upload assets

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hour max
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libosmium2-dev
          pip install osmium requests
      
      - name: Determine region type and name
        id: region
        run: |
          REGION="${{ github.event.inputs.region }}"
          
          # Check if it's a US state or international region
          if [[ "$REGION" == *"/"* ]]; then
            # International region (e.g., europe/spain)
            SAFE_NAME=$(echo "$REGION" | tr '/' '-')
            ARGS="--region $REGION"
          else
            # US state (e.g., virginia)
            SAFE_NAME="$REGION"
            ARGS="$REGION"
          fi
          
          echo "safe_name=$SAFE_NAME" >> $GITHUB_OUTPUT
          echo "args=$ARGS" >> $GITHUB_OUTPUT
          echo "Building: $REGION -> $SAFE_NAME.db"
      
      - name: Build database
        working-directory: tools
        run: |
          python build_state_db.py ${{ steps.region.outputs.args }}
      
      - name: Show results
        run: |
          echo "=== Built Databases ==="
          ls -lh tools/output/
          echo ""
          echo "=== Manifest ==="
          cat tools/output/manifest.json
      
      - name: Upload as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.region.outputs.safe_name }}-database
          path: |
            tools/output/*.db
            tools/output/manifest.json
          retention-days: 30
      
      - name: Upload to Release
        if: github.event.inputs.upload_to_release == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create release if it doesn't exist
          if ! gh release view databases > /dev/null 2>&1; then
            echo "Creating 'databases' release..."
            gh release create databases \
              --title "Offline Databases" \
              --notes "Pre-built offline address databases for the Address ATAK Plugin. Download the .db file for your region and place it in /sdcard/atak/tools/address/" \
              --latest
          fi
          
          # Upload database file (overwrite if exists)
          echo "Uploading ${{ steps.region.outputs.safe_name }}.db..."
          gh release upload databases \
            "tools/output/${{ steps.region.outputs.safe_name }}.db" \
            --clobber
          
          # Download existing manifest and merge with new one
          echo "Merging manifest.json..."
          if gh release download databases --pattern "manifest.json" --dir /tmp 2>/dev/null; then
            echo "Downloaded existing manifest, merging..."
            python3 << 'EOF'
          import json

          # Load existing manifest
          with open('/tmp/manifest.json', 'r') as f:
              existing = json.load(f)

          # Load new manifest
          with open('tools/output/manifest.json', 'r') as f:
              new = json.load(f)

          # Merge regions (new entries override existing with same id)
          existing_regions = {r['id']: r for r in existing.get('regions', [])}
          for region in new.get('regions', []):
              existing_regions[region['id']] = region

          # Update manifest
          existing['regions'] = sorted(existing_regions.values(), key=lambda x: x['name'])
          existing['version'] = new.get('version', existing.get('version', '2.0'))
          existing['schema_version'] = new.get('schema_version', existing.get('schema_version', 2))
          existing['poi_categories'] = new.get('poi_categories', existing.get('poi_categories', []))

          # Write merged manifest
          with open('tools/output/manifest.json', 'w') as f:
              json.dump(existing, f, indent=2)

          print(f"Merged manifest now has {len(existing['regions'])} regions")
          EOF
          else
            echo "No existing manifest, using new one"
          fi
          
          # Upload merged manifest
          echo "Uploading manifest.json..."
          gh release upload databases \
            "tools/output/manifest.json" \
            --clobber
          
          echo "âœ… Upload complete!"
          echo "Download at: https://github.com/${{ github.repository }}/releases/tag/databases"

